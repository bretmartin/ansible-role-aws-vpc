---

- name: get NAT instance facts
  ec2_remote_facts:
    profile:        '{{ aws_profile }}'
    aws_access_key: '{{ aws_iam_assume_role_access_key    | default(omit) }}'
    aws_secret_key: '{{ aws_iam_assume_role_secret_key    | default(omit) }}'
    security_token: '{{ aws_iam_assume_role_session_token | default(omit) }}'

    filters:
      'tag:Function': nat
      vpc-id: '{{ _aws_vpc_id }}'
    region: '{{ aws_region }}'
  register: _aws_vpc_nat_instance

- name: set NAT instance ID fact
  set_fact:
    _aws_vpc_nat_instance_id: '{{ _aws_vpc_nat_instance.instances[0].id }}'
  when: _aws_vpc_nat_instance.instances | length == 1

- name: set NAT gateway ID fact
  set_fact:
    _aws_vpc_nat_gateway_id: >-
      {% if _aws_vpc_existing_nat_gateway.result | length == 1 %}{{
        _aws_vpc_existing_nat_gateway.result[0].nat_gateway_id
      }}{% else %}{{
        _aws_vpc_created_nat_gateway.nat_gateway_id
      }}{% endif %}
  when: aws_vpc_nat_gateway
